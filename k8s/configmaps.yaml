apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-config
  namespace: ticketing-app
  labels:
    app.kubernetes.io/name: auth-service
    app.kubernetes.io/part-of: ticketing-system
data:
  AUTH_PORT: "4000"
  ACCESS_TOKEN_EXPIRES: "15m"
  REFRESH_TOKEN_EXPIRES: "7d"
  COOKIE_DOMAIN: "localhost"
  SECURE_COOKIES: "false"
  ACCOUNT_LOCK_THRESHOLD: "5"
  ACCOUNT_LOCK_MS: "900000"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-config
  namespace: ticketing-app
  labels:
    app.kubernetes.io/name: api-service
    app.kubernetes.io/part-of: ticketing-system
data:
  API_PORT: "5000"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-config
  namespace: ticketing-app
  labels:
    app.kubernetes.io/name: gateway
    app.kubernetes.io/part-of: ticketing-system
data:
  GATEWAY_PORT: "8443"
  GATEWAY_HTTP_PORT: "8080"
  FRONTEND_ORIGIN: "http://localhost"
  AUTH_SERVICE_URL: "http://auth-service:4000"
  API_SERVICE_URL: "http://api-service:5000"
  RATE_LIMIT_WINDOW_MS: "900000"
  RATE_LIMIT_MAX: "100"
  DISABLE_RATE_LIMIT: "true"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: front-config
  namespace: ticketing-app
  labels:
    app.kubernetes.io/name: front
    app.kubernetes.io/part-of: ticketing-system
data:
  VITE_API_BASE: "http://localhost/api"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-init-script
  namespace: ticketing-app
  labels:
    app.kubernetes.io/name: db
    app.kubernetes.io/part-of: ticketing-system
data:
  init.sql: |
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    CREATE TABLE IF NOT EXISTS users (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        email TEXT UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        role TEXT NOT NULL DEFAULT 'USER',
        is_active BOOLEAN NOT NULL DEFAULT TRUE,
        failed_login_attempts INT NOT NULL DEFAULT 0,
        lock_until TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS refresh_tokens (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        token_hash TEXT NOT NULL,
        expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
        revoked BOOLEAN NOT NULL DEFAULT FALSE,
        user_agent TEXT,
        ip_address TEXT
    );

    CREATE TABLE IF NOT EXISTS tickets (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        title TEXT NOT NULL,
        description TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'open',
        priority TEXT NOT NULL DEFAULT 'medium',
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS audit_logs (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID REFERENCES users(id) ON DELETE SET NULL,
        action TEXT NOT NULL,
        metadata JSONB,
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_tickets_user ON tickets(user_id);
    CREATE INDEX IF NOT EXISTS idx_logs_user ON audit_logs(user_id);
